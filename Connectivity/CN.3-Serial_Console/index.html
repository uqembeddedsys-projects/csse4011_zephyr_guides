<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://github.com/uqembeddedsys-projects/csse4011_zephyr_guides/Connectivity/CN.3-Serial_Console/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Serial Console - CSSE4011 Tutorial Docs</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "CSSE4011: Connectivity - Serial Console", url: "#_top", children: [
              {title: "1.0 Motivation", url: "#10-motivation" },
              {title: "1.1 Test Hardware", url: "#11-test-hardware" },
              {title: "1.2. Prerequisites", url: "#12-prerequisites" },
              {title: "2.0 Setting up Console", url: "#20-setting-up-console" },
              {title: "2.6 Sample Application", url: "#26-sample-application" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CN.4-Shell/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CN.4-Shell/" class="btn btn-xs btn-link">
        Shell
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../CN.2-Sensors/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../CN.2-Sensors/" class="btn btn-xs btn-link">
        Sensors
      </a>
    </div>
    
  </div>

    

    <h1 id="csse4011-connectivity-serial-console">CSSE4011: Connectivity - Serial Console<a class="headerlink" href="#csse4011-connectivity-serial-console" title="Permanent link">#</a></h1>
<p>The following tutorial will cover the setting up a console through USB with existing Zephyr Drivers. (Note that, USB Debugging/Shell can only be used with platforms that support USB, such as the NRF52840 SoC).</p>
<h2 id="10-motivation"><strong>1.0 Motivation</strong><a class="headerlink" href="#10-motivation" title="Permanent link">#</a></h2>
<p>Once USB console is setup, it can be used for printk() debugging, and/or to examine the internal data structures of an application where required.                     </p>
<h2 id="11-test-hardware">1.1 Test Hardware<a class="headerlink" href="#11-test-hardware" title="Permanent link">#</a></h2>
<p>This implementation will explore setting up the console on the Arduino Sense board.</p>
<blockquote>
<p>Arduino Sense Board</p>
<p>mUSB Cable</p>
</blockquote>
<p><strong>This implementation is valid for Zephyr RTOS Version 2.7.XX</strong></p>
<h2 id="12-prerequisites">1.2. Prerequisites<a class="headerlink" href="#12-prerequisites" title="Permanent link">#</a></h2>
<p>Ensure that you have completed/understand the following tutorials. </p>
<blockquote>
<p>OS.1, OS.2, OS.2.1 and BRD.1</p>
</blockquote>
<h2 id="20-setting-up-console"><strong>2.0 Setting up Console</strong><a class="headerlink" href="#20-setting-up-console" title="Permanent link">#</a></h2>
<h3 id="21-boilerplate"><strong>2.1 Boilerplate</strong><a class="headerlink" href="#21-boilerplate" title="Permanent link">#</a></h3>
<p><em>The following commands assume that you have setup your files/directories following the respective tutorial(s).</em></p>
<p>Create a new application directory for a sample console application. </p>
<pre><code class="language-shell">    cd ~/csse4011/csse4011_repo/
    mkdir -p apps/console_sample/
</code></pre>
<p>For setting up a basic boilerplate for our application, we will use the provided blinky sample in Zephyr. </p>
<pre><code class="language-shell">    cd ~/csse4011/zephyrproject/zephyr/samples/basic/blinky
    cp -R * ~/csse4011/csse4011_repo/apps/console_sample/
    cd ~/csse4011/csse4011_repo/apps/console_sample/
</code></pre>
<h3 id="22-enable-usb-drivers-prjconf"><strong>2.2 Enable USB Drivers [prj.conf]</strong><a class="headerlink" href="#22-enable-usb-drivers-prjconf" title="Permanent link">#</a></h3>
<p>To enable the existing USB drivers, a few config options need to be added to our project. A detailed guide for the USB API is found <a href="https://docs.zephyrproject.org/latest/reference/usb/uds_cdc_acm.html">here</a>, which you may need to refer to for additional information. </p>
<p>Start by editing the <strong>prj.conf</strong> file. Append the following config options. These options can be found <a href="https://docs.zephyrproject.org/latest/reference/devicetree/api.html">here</a>, for different subsystems. </p>
<pre><code class="language-CONF">CONFIG_GPIO=y

#------------------------------ENABLE USB---------------------------------------
CONFIG_BOARD_ARDUINO_NANO_33_BLE_EN_USB_CONSOLE=y
CONFIG_USB_DEVICE_STACK=y
CONFIG_USB_DEVICE_PRODUCT=&quot;USB Console Tute&quot;

CONFIG_SERIAL=y
CONFIG_CONSOLE=y
CONFIG_UART_CONSOLE=y
CONFIG_UART_LINE_CTRL=y
#------------------------------------------------------------------------------
</code></pre>
<p>Optionally, you can add the following config statements to add some flavour to the USB Stack... These commands let you set USB device ID parameters. </p>
<pre><code class="language-CONF">#--------------------------------USB OPTIONS----------------------------------
CONFIG_USB_DEVICE_PRODUCT=&quot;Arduino Nano BLE - Zephyr&quot;
CONFIG_USB_DEVICE_MANUFACTURER=&quot;Wilfred MK&quot;
CONFIG_USB_DEVICE_VID=0xC553
CONFIG_USB_DEVICE_PID=0x4011
#-----------------------------------------------------------------------------
</code></pre>
<h3 id="23-setting-up-cdc-acm-appoverlay"><strong>2.3 Setting up CDC-ACM [app.overlay]</strong><a class="headerlink" href="#23-setting-up-cdc-acm-appoverlay" title="Permanent link">#</a></h3>
<p>Zephyr v2.7 require an overlay file to be added to specify Communication Device Class - Abstract Control Model (CDC-ACM). The CDC ACM can be used as backends for Zephyr Subsystems, such as console and shell. </p>
<p>There is detailed information about how an overlay is implemented and it's purpose in this sub-system which can be found <a href="https://docs.zephyrproject.org/latest/reference/usb/uds_cdc_acm.html">here</a>. </p>
<p>For this particular example, start by making an <strong>app.overlay</strong>. If there exists a file named <strong>app.overlay</strong> in the app directory, it get added to the build system by default (See <a href="https://docs.zephyrproject.org/latest/guides/dts/howtos.html">here</a>, for device tree overlays). </p>
<pre><code class="language-shell">cd ~/csse4011/csse4011_repo/apps/console_sample/        #App Directory
vim app.overlay                                         #Use any text editor
</code></pre>
<p>Copy the following overlay details into the newly created file. This is adding a devicetree overlay to the build system, see <a href="https://docs.zephyrproject.org/latest/reference/devicetree/api.html">here</a> for more. Here we specify the console should be routed to cdc_acm_uart0.</p>
<pre><code class="language-DTS">/ {
        chosen {
                zephyr,console = &amp;cdc_acm_uart0;
        };
};

&amp;zephyr_udc0 {
        cdc_acm_uart0: cdc_acm_uart0 {
                compatible = &quot;zephyr,cdc-acm-uart&quot;;:q
                label = &quot;CDC_ACM_0&quot;;
        };
};
</code></pre>
<h3 id="24-initializing-the-driver-mainc"><strong>2.4 Initializing the Driver [main.c]</strong><a class="headerlink" href="#24-initializing-the-driver-mainc" title="Permanent link">#</a></h3>
<p>At this point, ensure that there are no compile errors by running</p>
<pre><code class="language-shell">west build -p -b arduino_nano_33_ble
</code></pre>
<p>and now we tell our application to initialize the USB and print some data.</p>
<pre><code class="language-shell">vim src/main.c
</code></pre>
<pre><code class="language-C">#include &lt;usb/usb_device.h&gt;
#include &lt;drivers/uart.h&gt;       //Include these libraries

//Add the following to main()
void
main(void)
{

    /* Setup DTR */
    const struct device *console_dev = DEVICE_DT_GET(DT_CHOSEN(zephyr_console));
    uint32_t dtr = 0;

    /* Enable the USB Driver */
    if (usb_enable(NULL))   
        return;

   /* Wait on DTR - 'Data Terminal Ready'
    * Will wait here until a terminal has been attached to the device
    * This is not necessary, however, can be useful for printing boot info etc..
    */
    while (!dtr) {
        uart_line_ctrl_get(console_dev, UART_LINE_CTRL_DTR, &amp;dtr);
        k_sleep(K_MSEC(100));
    }

    while(1)
    {
        printk(&quot;Hello World\n&quot;);
        k_sleep(K_MSEC(500));
    }
}
</code></pre>
<h3 id="25-testing"><strong>2.5 Testing</strong><a class="headerlink" href="#25-testing" title="Permanent link">#</a></h3>
<p>This application can now be built and flashed using:</p>
<pre><code class="language-shell">west  build -p auto -b arduino_nano_33_ble
west flash --bossac=$HOME/csse4011/BOSSA/BOSSA/bin/bossac   #Check the Path is correct
</code></pre>
<p>Since this is now a <strong>'new usb device'</strong>, <strong>you will need to pass through USB from your host machine to the VM to open the console within your CSSE4011 VM</strong> Typically, you might have to unplug and reconnect the device for the pass through to take effect. Alternatively, you should be able to view the console on the host machine also.</p>
<p>See that the device is connected </p>
<pre><code class="language-shell">lsusb  #Command to show currently attached USB devices

Bus 001 Device 099: ID c553:4011 Wilfred MK Arduino Nano BLE - Zephyr #You will see this if you added the USB OPTIONS from above
</code></pre>
<p>First install screen (App that can monitor terminal)</p>
<pre><code class="language-shell">sudo apt-get install screen
</code></pre>
<pre><code class="language-shell">sudo screen /dev/ttyACM0

Hello World
Hello World
Hello World
</code></pre>
<h2 id="26-sample-application"><strong>2.6 Sample Application</strong><a class="headerlink" href="#26-sample-application" title="Permanent link">#</a></h2>
<p>A sample application has been provided, this application includes all the steps mentioned above. You can test the console by flashing it to the Arduino Sense Board.</p>
<p>Sample is located in <strong>REPO_TOP/tute_solutions/console_example/</strong></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CN.4-Shell/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CN.4-Shell/" class="btn btn-xs btn-link">
        Shell
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../CN.2-Sensors/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../CN.2-Sensors/" class="btn btn-xs btn-link">
        Sensors
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>
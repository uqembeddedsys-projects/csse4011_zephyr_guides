<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://github.com/uqembeddedsys-projects/csse4011_zephyr_guides/Connectivity/CN.4-Shell/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Shell - CSSE4011 Tutorial Docs</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "CSSE4011: Connectivity - Shell", url: "#_top", children: [
              {title: "1.0 Motivation", url: "#10-motivation" },
              {title: "1.1 Test Hardware", url: "#11-test-hardware" },
              {title: "1.2. Prerequisites", url: "#12-prerequisites" },
              {title: "1.3 Setup", url: "#13-setup" },
              {title: "2.0 Zephyr Shell Implementation", url: "#20-zephyr-shell-implementation" },
              {title: "2.7 Sample Application", url: "#27-sample-application" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CN.4.1-Shell_Commands/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CN.4.1-Shell_Commands/" class="btn btn-xs btn-link">
        Shell Commands
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../CN.3-Serial_Console/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../CN.3-Serial_Console/" class="btn btn-xs btn-link">
        Serial Console
      </a>
    </div>
    
  </div>

    

    <h1 id="csse4011-connectivity-shell">CSSE4011: Connectivity - Shell<a class="headerlink" href="#csse4011-connectivity-shell" title="Permanent link">#</a></h1>
<p>The following tutorial will cover the setting up a command line interface/Shell through USB with existing Zephyr Drivers. (Note that, USB Debugging/Shell can only be used with platforms that support USB, such as the NRF52840 SoC).</p>
<h2 id="10-motivation"><strong>1.0 Motivation</strong><a class="headerlink" href="#10-motivation" title="Permanent link">#</a></h2>
<p>A shell or a command line interface (CLI) allows for a user to interact with the OS in real time. Shell commands can be used to issue unique commands to a device or change application logic. For example, a command to read run-time statistics of threads or to turn an led on or off etc...</p>
<p>Zephyr also allows for Shell to be used as a backend for the Zephyr Logging API. The logging API is explored in <strong><em>CN.5-Logging</em></strong>.</p>
<h2 id="11-test-hardware">1.1 Test Hardware<a class="headerlink" href="#11-test-hardware" title="Permanent link">#</a></h2>
<blockquote>
<p>Arduino Sense Board</p>
<p>mUSB Cable</p>
</blockquote>
<p><strong>This implementation is valid for Zephyr RTOS Version 2.7.XX</strong></p>
<h2 id="12-prerequisites">1.2. Prerequisites<a class="headerlink" href="#12-prerequisites" title="Permanent link">#</a></h2>
<p>Ensure that you have completed/understand the following tutorials. </p>
<blockquote>
<p>OS.1, OS.2, OS.2.1 and BRD.1</p>
</blockquote>
<h2 id="13-setup">1.3 Setup<a class="headerlink" href="#13-setup" title="Permanent link">#</a></h2>
<p>Connect the Arduino sense board to the host machine and ensure that the development environment has access to the device (USB passthrough to virtual machine).</p>
<h2 id="20-zephyr-shell-implementation"><strong>2.0 Zephyr Shell Implementation</strong><a class="headerlink" href="#20-zephyr-shell-implementation" title="Permanent link">#</a></h2>
<h3 id="21-boilerplate"><strong>2.1 Boilerplate</strong><a class="headerlink" href="#21-boilerplate" title="Permanent link">#</a></h3>
<p><em>The following commands assume that you have setup your files/directories following the respective tutorial(s).</em></p>
<p>Create a new application directory for a sample shell application. </p>
<pre><code class="language-shell">    cd ~/csse4011/csse4011_repo/
    mkdir -p apps/shell_sample/
</code></pre>
<p>For setting up a basic boilerplate for our application, we will use the provided blinky sample in Zephyr. </p>
<pre><code class="language-shell">    cd ~/csse4011/zephyrproject/zephyr/samples/basic/blinky
    cp -R * ~/csse4011/csse4011_repo/apps/shell_sample/
    cd ~/csse4011/csse4011_repo/apps/shell_sample/
</code></pre>
<h3 id="22-enable-usb-drivers-prjconf"><strong>2.2 Enable USB Drivers [prj.conf]</strong><a class="headerlink" href="#22-enable-usb-drivers-prjconf" title="Permanent link">#</a></h3>
<p>To show a more structure approach to setting configs in Zephyr, in this tutorials we will explore the addition of segmented config files to the build system. Where each file represents a different subsystem. Such an approach improves modularity for bigger projects. </p>
<p>First, we will enable the USB subsystem as before, </p>
<p><em>These options can be found <a href="https://docs.zephyrproject.org/latest/guides/dts/howtos.html#set-devicetree-overlays">here</a>, for diffrent subsystems.</em></p>
<pre><code class="language-shell">vim usb.conf  #create a new .conf file for the USB subsystem
</code></pre>
<p>Append the following, then save and exit the editor.</p>
<pre><code class="language-CONF">#----------------------------------USB SETUP----------------------------------
CONFIG_USB_DEVICE_STACK=y
CONFIG_USB_DEVICE_PRODUCT=&quot;Zephyr USB shell sample&quot;
#-----------------------------------------------------------------------------

#--------------------------------USB_OPTIONS----------------------------------
CONFIG_USB_DEVICE_PRODUCT=&quot;Arduino Nano BLE - Zephyr&quot;
CONFIG_USB_DEVICE_MANUFACTURER=&quot;Wilfred MK&quot;
CONFIG_USB_DEVICE_VID=0xC553
CONFIG_USB_DEVICE_PID=0x4011
#-----------------------------------------------------------------------------
</code></pre>
<p>Next, we will enable Zephyr Shell, </p>
<pre><code class="language-shell">vim shell.conf #create a new .conf file for shell options
</code></pre>
<p>append the following config settings.</p>
<pre><code class="language-CONF">#-----------------------------SHELL_CONF--------------------------------------
CONFIG_SHELL_BACKEND_SERIAL_CHECK_DTR=y
CONFIG_UART_LINE_CTRL=y
CONFIG_SHELL_BACKEND_SERIAL_INIT_PRIORITY=51
CONFIG_SHELL=y
CONFIG_SHELL_BACKENDS=y
CONFIG_SHELL_BACKEND_SERIAL=y

CONFIG_SHELL_PROMPT_UART=&quot;CSSE4011:~$&quot;

CONFIG_SHELL_CMDS=y
CONFIG_SHELL_TAB=y
CONFIG_SHELL_TAB_AUTOCOMPLETION=y
CONFIG_SHELL_VT100_COLORS=y
CONFIG_KERNEL_SHELL=y
#-----------------------------------------------------------------------------

#-----------------------------SHELL_LOGGING-----------------------------------
CONFIG_LOG=y
CONFIG_LOG_PRINTK=y
#-----------------------------------------------------------------------------
</code></pre>
<p>Save the file and exit the editor.</p>
<h3 id="23-shell-usb-overlay"><strong>2.3 Shell USB Overlay</strong><a class="headerlink" href="#23-shell-usb-overlay" title="Permanent link">#</a></h3>
<p>As with the console, we must inform Zephyr that the <strong>shell-uart is to be routed through the USB subsystem using CDC_ACM</strong>. This can be done by creating and adding an overlay file to the build-system. An '<em>app.overlay'</em> file can be created similarly to the console tutorial, and this will automatically be picked up by the <a href="https://docs.zephyrproject.org/latest/guides/dts/howtos.html#set-devicetree-overlays">build-system</a>. However, here we will explore manually adding it to the build system. </p>
<pre><code class="language-shell">vim dtc_shell.overlay #create new file for shell overlay
</code></pre>
<p>append the following to the file.</p>
<pre><code class="language-DTS">/ {
        chosen {
                zephyr,shell-uart = &amp;cdc_acm_uart0;
        };
};

&amp;zephyr_udc0 {
        cdc_acm_uart0: cdc_acm_uart0 {
                compatible = &quot;zephyr,cdc-acm-uart&quot;;
                label = &quot;CDC_ACM_0&quot;;
        };
};
</code></pre>
<p>Save and exit the editor.</p>
<h3 id="24-adding-files-to-cmakelists"><strong>2.4 Adding files to CMakeLists</strong><a class="headerlink" href="#24-adding-files-to-cmakelists" title="Permanent link">#</a></h3>
<p>At this point, we have created our config/overlay files. We must add these to our build system for any of them to take effect (if a file is named app.conf, it is picked up by the build system by default, as seen in <em>CN.3-Serial_Console</em>). More details on this can be found <a href="https://docs.zephyrproject.org/latest/application/index.html">here</a>.</p>
<pre><code class="language-shell">vim CMakeLists.txt
</code></pre>
<p>At the top of the file, append the following to add the newly created config files to CMakeLists.</p>
<pre><code>set(CONF_FILE usb.conf shell.conf)
set(DTC_OVERLAY_FILE dtc_shell.overlay)
</code></pre>
<h3 id="25-initializing-the-driver-mainc"><strong>2.5 Initializing the Driver [main.c]</strong><a class="headerlink" href="#25-initializing-the-driver-mainc" title="Permanent link">#</a></h3>
<p>At this point, ensure that there are no compile errors by running</p>
<pre><code class="language-shell">west build -p -b arduino_nano_33_ble
</code></pre>
<p>and now we tell our application to initialize the USB stack.</p>
<pre><code class="language-shell">vim src/main.c
</code></pre>
<pre><code class="language-C">#include &lt;usb/usb_device.h&gt;
#include &lt;drivers/uart.h&gt;       //Include these libraries

//Add the following to main()
void
main(void)
{

    /* Setup DTR */
    const struct device *shell_dev = DEVICE_DT_GET(DT_CHOSEN(zephyr_shell_uart));
    uint32_t dtr = 0;

    /* Enable the USB Driver */
    if (usb_enable(NULL))   
        return;

   /* Wait on DTR - 'Data Terminal Ready'
    * Will wait here until a terminal has been attached to the device
    * This is not necessary, however, can be useful for printing boot info etc..
    */
    while (!dtr) {
        uart_line_ctrl_get(shell_dev, UART_LINE_CTRL_DTR, &amp;dtr);
        k_sleep(K_MSEC(100));
    }

    while(1)
    {
        //printk(&quot;Hello World\n&quot;);  //This will get routed to the shell also (optional)
        k_sleep(K_MSEC(500));
    }
}
</code></pre>
<h3 id="26-testing"><strong>2.6 Testing</strong><a class="headerlink" href="#26-testing" title="Permanent link">#</a></h3>
<p>This application can now be built and flashed using:</p>
<pre><code class="language-shell">west  build -p auto -b arduino_nano_33_ble
west flash --bossac=$HOME/csse4011/BOSSA/BOSSA/bin/bossac   #Check the Path is correct
</code></pre>
<p>Since this is now a <strong>'new usb device'</strong>, <strong>you will need to pass through USB from your host machine to the VM to open the shell within your CSSE4011 VM</strong> Typically, you might have to unplug and reconnect the device for the pass through to take effect. Alternatively, you should be able to view the shell on the host machine also.</p>
<p>See that the device is connected </p>
<pre><code class="language-shell">lsusb  #Command to show currently attached USB devices

Bus 001 Device 099: ID c553:4011 Wilfred MK Arduino Nano BLE - Zephyr #You will see this if you added the USB OPTIONS from above
</code></pre>
<p>First install screen (App that can monitor terminal)</p>
<pre><code class="language-shell">sudo apt-get install screen
</code></pre>
<pre><code class="language-shell">sudo screen /dev/ttyACM0
</code></pre>
<p>You can press 'tab' to see the currently enabled options through shell.</p>
<pre><code>[00:00:11.851,226] &lt;inf&gt; usb_cdc_acm: Device resumed
[00:00:11.851,257] &lt;inf&gt; usb_cdc_acm: from suspend
CSSE4011:~$
  clear              device             devmem             help
  history            hwinfo             kernel             log
  nrf_clock_control  resize             shell
</code></pre>
<pre><code>CSSE4011:~$kernel threads
Scheduler: 23890 since last call
Threads:
*0x20000438 shell_uart
        options: 0x0, priority: 14 timeout: 536872112
        state: queued, entry: 0x13029
        stack size 2048, unused 1176, usage 872 / 2048 (42 %)

</code></pre>
<h2 id="27-sample-application"><strong>2.7 Sample Application</strong><a class="headerlink" href="#27-sample-application" title="Permanent link">#</a></h2>
<p>A sample application has been provided, this application includes all the steps mentioned above. You can test the shell by flashing it to the Arduino Sense Board.</p>
<p>Sample is located in <strong>REPO_TOP/tute_solutions/shell_example/</strong></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CN.4.1-Shell_Commands/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CN.4.1-Shell_Commands/" class="btn btn-xs btn-link">
        Shell Commands
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../CN.3-Serial_Console/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../CN.3-Serial_Console/" class="btn btn-xs btn-link">
        Serial Console
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>
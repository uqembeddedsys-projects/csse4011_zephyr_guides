<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://github.com/uqembeddedsys-projects/csse4011_zephyr_guides/OS/OS.5.1-Thread_Sync/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Thread Synchronization - CSSE4011 Tutorial Docs</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "CSSE4011: Tute 5.1 - Thread Synchronization", url: "#_top", children: [
              {title: "1.0 Motivation", url: "#10-motivation" },
              {title: "1.1 Thread Synchronization Summary", url: "#11-thread-synchronization-summary" },
              {title: "2.0 Thread Synchronization and Communication in Zephyr", url: "#20-thread-synchronization-and-communication-in-zephyr" },
              {title: "2.1 Thread Synchronization in Zephyr", url: "#21-thread-synchronization-in-zephyr" },
              {title: "2.2 Semaphore Implementation", url: "#22-semaphore-implementation" },
              {title: "2.3 Mutex in Zephyr", url: "#23-mutex-in-zephyr" },
              {title: "2.4 Condition Variables in Zephyr", url: "#24-condition-variables-in-zephyr" },
              {title: "3.0 Tutorial Question", url: "#30-tutorial-question" },
              {title: "3.1 Sample Solution", url: "#31-sample-solution" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../OS.5.2-Thread_Communication/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../OS.5.2-Thread_Communication/" class="btn btn-xs btn-link">
        Thread Communication
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../OS.4-Threading/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../OS.4-Threading/" class="btn btn-xs btn-link">
        Threading
      </a>
    </div>
    
  </div>

    

    <h1 id="csse4011-tute-51-thread-synchronization">CSSE4011: Tute 5.1 - Thread Synchronization<a class="headerlink" href="#csse4011-tute-51-thread-synchronization" title="Permanent link">#</a></h1>
<h2 id="10-motivation"><strong>1.0 Motivation</strong><a class="headerlink" href="#10-motivation" title="Permanent link">#</a></h2>
<p>In the previous tutorial, basic thread creation and usage was covered. In this tutorial, we aim to cover thread synchronization.</p>
<h2 id="11-thread-synchronization-summary"><strong>1.1 Thread Synchronization Summary</strong><a class="headerlink" href="#11-thread-synchronization-summary" title="Permanent link">#</a></h2>
<p>Thead synchronization is typically used for sharing of resources without interference (mutual exclusion) and for coordinating the thread functionality and interactions within the operating system. </p>
<p>For example, think of a resource where multiple threads write to a shared resource. It is important to ensure that only one writer is currently writing to the resource, to avoid interference and data corruption. In such a case, synchronization must be used between the writer threads to ensure intended functionality. Additionally, the application could use coordination between reader and writer threads, so that readers only read when data is ready. </p>
<p>In an embedded environment, an application might want to enforce that only one thread is accessing hardware (senors etc..) at a time, or to indicate that a particular hardware resource is ready to use. In such a case, synchronization must be used. </p>
<h2 id="20-thread-synchronization-and-communication-in-zephyr"><strong>2.0 Thread Synchronization and Communication in Zephyr</strong><a class="headerlink" href="#20-thread-synchronization-and-communication-in-zephyr" title="Permanent link">#</a></h2>
<h2 id="21-thread-synchronization-in-zephyr"><strong>2.1 Thread Synchronization in Zephyr</strong><a class="headerlink" href="#21-thread-synchronization-in-zephyr" title="Permanent link">#</a></h2>
<p>Zephyr offers multiple synchronization primitives, such as:</p>
<ol>
<li>
<p><a href="https://docs.zephyrproject.org/latest/reference/kernel/synchronization/semaphores.html">Semaphores</a></p>
</li>
<li>
<p><a href="https://docs.zephyrproject.org/latest/reference/kernel/synchronization/mutexes.html">Mutexs</a>  </p>
</li>
<li>
<p><a href="https://docs.zephyrproject.org/latest/reference/kernel/synchronization/condvar.html">Condition Variables</a> </p>
</li>
</ol>
<p>Refer to the API guides (links section) for detailed information on implementing each of the above. In this tute, we will explore using semaphores to synchronize the blinky thread created in <em>OS.4-Threading</em>. </p>
<h2 id="22-semaphore-implementation"><strong>2.2 Semaphore Implementation</strong><a class="headerlink" href="#22-semaphore-implementation" title="Permanent link">#</a></h2>
<p>Within Zephyr, a semaphore can be defined by the use of the following macro</p>
<pre><code class="language-C">K_SEM_DEFINE(sem_name, 0, 1);
</code></pre>
<p>or, using the function  <em>k_sem_init()</em></p>
<pre><code class="language-C">struct k_sem sem_name;

void
main(void)
{
    k_sem_init(&amp;sem_name, 0, 1);
}
</code></pre>
<p>The typical application of a semaphore can be as seen below:</p>
<pre><code class="language-C">void
interrupt_handler(void *arg)
{
    /* Interrupt indicative of some data ready */
    k_sem_give(&amp;data_ready_sem);
}

void
consumer_thread(void)
{
    while(1)
    {
        if (k_sem_take(&amp;data_ready_sem, K_MSEC(850) != 0)) {
            /* 
             * Data not received within expected timeout of 850ms, 
             * fallback subroutine...
             */
             continue;
        }

        /* Semaphore was attained within time out */

        /* Read the data, and do some work... */
        k_msleep(500);
    }
}
</code></pre>
<p>The example above, shows a scenario where a semaphore is used to signal by an interrupt handler that some data is ready. Similarly, semaphores can be used between multiple threads for coordination and signaling. </p>
<p>Refer to <a href="https://docs.zephyrproject.org/latest/reference/kernel/synchronization/semaphores.html">here</a>, for additional implementation information. </p>
<h2 id="23-mutex-in-zephyr"><strong>2.3 Mutex in Zephyr</strong><a class="headerlink" href="#23-mutex-in-zephyr" title="Permanent link">#</a></h2>
<p>A mutex in Zephyr RTOS is a kernel object that implements the traditional functionality of a mutex. A mutex can allow multiple threads to safely access and share hardware or software resources <a href="https://docs.zephyrproject.org/latest/reference/kernel/synchronization/mutexes.html">as per</a>. Where a semaphore <strong>may allow finite access</strong> (i.e counting semaphore) to a resource, mutexs only allow a thread to access one resource at a time (a locking mechanism). </p>
<p>The mutex implementation api within Zephyr is functionally similar to that of the semaphore api outlined in <strong><em>section 2.2</em></strong>. See <a href="https://docs.zephyrproject.org/latest/reference/kernel/synchronization/condvar.html">here</a> for Zephyr mutex api guide.</p>
<h2 id="24-condition-variables-in-zephyr"><strong>2.4 Condition Variables in Zephyr</strong><a class="headerlink" href="#24-condition-variables-in-zephyr" title="Permanent link">#</a></h2>
<p>Zephyr allows for 'Condition Variables' to be used as a synchronization primitive, where, threads can wait on until a particular condition has occurred. Waiting threads will be in a queue when a particular state of execution is not desired (by waiting on the condition).</p>
<p><a href="https://docs.zephyrproject.org/latest/reference/kernel/synchronization/condvar.html">Zephyr Condition Variable API</a> shows the following example to be  a typical conditional variable implementation with two threads. In the <strong><em>main</em></strong> thread, </p>
<pre><code class="language-C">K_MUTEX_DEFINE(mutex);
K_CONDVAR_DEFINE(condvar)

void main(void)
{
    k_mutex_lock(&amp;mutex, K_FOREVER);

    /* block this thread until another thread signals cond. While
     * blocked, the mutex is released, then re-acquired before this
     * thread is woken up and the call returns.
     */
    k_condvar_wait(&amp;condvar, &amp;mutex, K_FOREVER);
    ...
    k_mutex_unlock(&amp;mutex);
}
</code></pre>
<p>and in the <strong><em>worker</em></strong> thread,</p>
<pre><code class="language-C">void worker_thread(void)
{
    k_mutex_lock(&amp;mutex, K_FOREVER);

    /*
     * Do some work and fulfill the condition
     */
    ...
    ...
    k_condvar_signal(&amp;condvar);
    k_mutex_unlock(&amp;mutex);
}
</code></pre>
<h3 id="241-condition-variable-typical-use"><strong>2.4.1 Condition Variable Typical Use</strong><a class="headerlink" href="#241-condition-variable-typical-use" title="Permanent link">#</a></h3>
<p>Condition variables should be used with a mutex to signal changing conditions/states from one thread to another. Condition variables are not <strong><em>events</em></strong> in that they are not the <strong><em>condition</em></strong> itself.</p>
<p><strong>Refer to the <a href="https://docs.zephyrproject.org/latest/reference/kernel/synchronization/condvar.html">implementation API</a> for more details.</strong></p>
<h2 id="30-tutorial-question"><strong>3.0 Tutorial Question</strong><a class="headerlink" href="#30-tutorial-question" title="Permanent link">#</a></h2>
<blockquote>
<ol>
<li>Use two semaphores to enforce synchronization between the two blinky threads created in tute OS.4-Threading.</li>
</ol>
</blockquote>
<p>The implementation should only use delays to indicate that the led visibly blinks. </p>
<h2 id="31-sample-solution"><strong>3.1 Sample Solution</strong><a class="headerlink" href="#31-sample-solution" title="Permanent link">#</a></h2>
<p>A sample solution is uploaded in the docs repository. Find located within,</p>
<blockquote>
<p>tute_solutions/OS-5.1_tute/src/</p>
</blockquote>
<p>This code can be built with:</p>
<blockquote>
<p>west build -p -b <board_name></p>
</blockquote>
<p>and flashed with</p>
<blockquote>
<p>west flash -r 'runner'</p>
</blockquote>
<p>Refer to the board flashing tutorials for additional build/flash guides.</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../OS.5.2-Thread_Communication/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../OS.5.2-Thread_Communication/" class="btn btn-xs btn-link">
        Thread Communication
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../OS.4-Threading/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../OS.4-Threading/" class="btn btn-xs btn-link">
        Threading
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>